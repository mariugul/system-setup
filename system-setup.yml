---
- hosts: localhost
  become: yes
  tasks:
    - name: Install prerequisites
      apt:
        name:
          - curl
          - wget
          - gpg
          - apt-transport-https
          - software-properties-common
        state: present
        update_cache: yes

    - name: Install git
      apt:
        name: git
        state: present
        update_cache: yes

    - name: Add VS Code GPG key
      apt_key:
        url: https://packages.microsoft.com/keys/microsoft.asc
        state: present

    - name: Add VS Code repository
      apt_repository:
        repo: "deb [arch=amd64] https://packages.microsoft.com/repos/code stable main"
        state: present
        filename: vscode

    - name: Install VS Code
      apt:
        name: code
        state: present

    - name: Ensure wget and gpg are installed for Windsurf
      apt:
        name:
          - wget
          - gpg
        state: present
        update_cache: yes

    - name: Download Windsurf GPG key and convert to keyring
      shell: |
        wget -qO- "https://windsurf-stable.codeiumdata.com/wVxQEIWkwPUEAGf3/windsurf.gpg" | gpg --dearmor > windsurf-stable.gpg
      args:
        creates: windsurf-stable.gpg

    - name: Install Windsurf keyring
      shell: sudo install -D -o root -g root -m 644 windsurf-stable.gpg /etc/apt/keyrings/windsurf-stable.gpg
      args:
        creates: /etc/apt/keyrings/windsurf-stable.gpg

    - name: Add Windsurf repository
      shell: echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/windsurf-stable.gpg] https://windsurf-stable.codeiumdata.com/wVxQEIWkwPUEAGf3/apt stable main" | sudo tee /etc/apt/sources.list.d/windsurf.list > /dev/null
      args:
        creates: /etc/apt/sources.list.d/windsurf.list

    - name: Remove temporary Windsurf GPG file
      file:
        path: windsurf-stable.gpg
        state: absent

    - name: Ensure apt-transport-https is installed
      apt:
        name: apt-transport-https
        state: present

    - name: Update apt cache after adding Windsurf repo
      apt:
        update_cache: yes

    - name: Install Windsurf
      apt:
        name: windsurf
        state: present

    - name: Add Slack GPG key
      apt_key:
        url: https://packagecloud.io/slacktechnologies/slack/gpgkey
        state: present

    - name: Add Slack repository
      apt_repository:
        repo: "deb [arch=amd64] https://packagecloud.io/slacktechnologies/slack/debian/ jessie main"
        state: present
        filename: slack

    - name: Install Slack
      apt:
        name: slack-desktop
        state: present

    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
        filename: docker

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present

    - name: Add user to docker group
      user:
        name: "{{ lookup('env','USER') }}"
        groups: docker
        append: yes

    - name: Install Astral's uv
      shell: curl -LsSf https://astral.sh/uv/install.sh | sh
      args:
        creates: /usr/local/bin/uv

    - name: Install GitHub CLI (gh)
      shell: |
        type -p curl >/dev/null || sudo apt-get install curl -y
        sudo mkdir -p -m 0755 /etc/apt/keyrings
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/etc/apt/keyrings/githubcli-archive-keyring.gpg
        sudo chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo apt-get update
        sudo apt-get install gh -y
      args:
        creates: /usr/bin/gh

    - name: Install python3-venv
      apt:
        name: python3-venv
        state: present
        update_cache: yes

    - name: Install python3-dev
      apt:
        name: python3-dev
        state: present
        update_cache: yes

    - name: Install bash-aliases
      shell: curl -sS https://raw.githubusercontent.com/mariugul/bash-aliases/main/install.sh | bash
      args:
        creates: ~/.bash_aliases

    - name: Ensure SSH key exists
      shell: |
        ssh-keygen -t ed25519 -C "$(whoami)@$(hostname)" -f ~/.ssh/id_ed25519 -N ""
      args:
        creates: ~/.ssh/id_ed25519

    - name: Check if gh CLI is authenticated
      shell: gh auth status --hostname github.com
      register: gh_auth_status
      ignore_errors: true

    - name: Authenticate gh CLI with GitHub if not already
      shell: gh auth login --hostname github.com --web
      when: gh_auth_status.rc != 0
      args:
        creates: ~/.config/gh/hosts.yml

    - name: Check if SSH key is already uploaded to GitHub
      shell: gh ssh-key list --json title,key | grep -F "$(cat ~/.ssh/id_ed25519.pub | cut -d' ' -f2)"
      register: gh_ssh_key_exists
      ignore_errors: true

    - name: Upload SSH key to GitHub if not present
      shell: gh ssh-key add ~/.ssh/id_ed25519.pub --title "$(hostname)"
      when: gh_ssh_key_exists.rc != 0
      args:
        creates: ~/.ssh/id_ed25519.pub
